<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="com.booking.boot.mapper.EducationMapper">
  	 <select id="getCourses" parameterType="com.booking.boot.Dto.SearchDto" resultType="com.booking.boot.Dto.CourseDto">
    SELECT 
      c.course_id,
      c.instructor_id,
      c.title,
      c.description,
      c.created_at,
      c.price,
      c.level,
      c.category_id,
      -- Ïù¥ÎØ∏ÏßÄ: Ï≤´ Î≤àÏß∏Îßå Í∞ÄÏ†∏Ïò§Í∏∞
      (SELECT img 
         FROM course_photos p 
        WHERE c.course_id = p.course_id 
          AND ROWNUM = 1) AS img
    FROM courses c
    <where>
      <!-- üîç Í≤ÄÏÉâ Ï°∞Í±¥ -->
      <if test="searchField != null and searchField != '' and searchWord != null and searchWord != ''">
        <foreach collection="searchField.split('/')" item="field" open="(" close=")" separator="OR">
          ${field} LIKE '%' || #{searchWord} || '%'
        </foreach>
      </if>

      <!-- üìå Ïπ¥ÌÖåÍ≥†Î¶¨ ÌïÑÌÑ∞ -->
      <if test="categoryId != null">
        AND c.category_id IN (
          SELECT category_id 
          FROM categories
          START WITH category_id = #{categoryId}
          CONNECT BY PRIOR category_id = parent_id
        )
      </if>
    </where>
    ORDER BY c.created_at DESC
    OFFSET (#{pageNo} - 1) * #{amount} ROWS 
    FETCH NEXT #{amount} ROWS ONLY
  </select>

  <!-- üìå Ï†ÑÏ≤¥ Í∞úÏàò (ÌéòÏù¥ÏßïÏö©) -->
  <select id="getTotalCount" parameterType="com.booking.boot.Dto.SearchDto" resultType="int">
    SELECT COUNT(*)
    FROM courses c
    <where>
      <if test="searchField != null and searchField != '' and searchWord != null and searchWord != ''">
        <foreach collection="searchField.split('/')" item="field" open="(" close=")" separator="OR">
          ${field} LIKE '%' || #{searchWord} || '%'
        </foreach>
      </if>

      <if test="categoryId != null">
        AND c.category_id IN (
          SELECT category_id 
          FROM categories
          START WITH category_id = #{categoryId}
          CONNECT BY PRIOR category_id = parent_id
        )
      </if>
    </where>
  </select>

  <!-- üìå ÏÑúÎ∏å Ïπ¥ÌÖåÍ≥†Î¶¨ Î™©Î°ù -->
  <select id="getSubCategoryList" parameterType="int" resultType="com.booking.boot.Dto.CategoryDto">
    SELECT 
      category_id,
      course_id,
      name,
      parent_id,
      title
    FROM categories
    WHERE LEVEL BETWEEN 1 AND 2
    START WITH category_id = #{categoryId}
    CONNECT BY PRIOR category_id = parent_id
  </select>
  </mapper>